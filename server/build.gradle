apply plugin: 'org.springframework.boot'
apply plugin: 'com.bmuschko.docker-remote-api'

dependencies {
    implementation project(':protocol')

    implementation 'com.linecorp.armeria:armeria-spring-boot-webflux-starter'
    implementation 'com.linecorp.armeria:armeria-grpc'

    implementation 'org.springframework.boot:spring-boot-starter-actuator'

    implementation 'com.hubspot.slack:slack-base'

    implementation 'com.linecorp.bot:line-bot-model'

    runtime 'ch.qos.logback:logback-classic'
    runtime 'org.slf4j:log4j-over-slf4j'
    runtime 'ch.qos.logback.contrib:logback-json-classic'
    runtime 'ch.qos.logback.contrib:logback-jackson'
}

springBoot {
    buildInfo()
}

docker {
    registryCredentials {
        username = project.hasProperty('dockerUsername') ? dockerUsername : System.getenv('DOCKER_USERNAME')
        password = project.hasProperty('dockerPassword') ? dockerPassword : System.getenv('DOCKER_PASSWORD')
    }
}

task dockerUnpackDependencies(type: Copy) {
    dependsOn bootJar
    from(zipTree(tasks.bootJar.outputs.files.singleFile))
    into("$buildDir/docker/dependency")
}

task dockerCopyDockerfile(type: Copy) {
    from("$projectDir/Dockerfile")
    into("$buildDir/docker")
}

import com.bmuschko.gradle.docker.tasks.image.*
task dockerBuildImage(type: DockerBuildImage) {
    dependsOn dockerCopyDockerfile, dockerUnpackDependencies
    inputDir = file("$buildDir/docker")
    buildArgs = ['DEPENDENCY': 'dependency']
    tags = ['delegacy/young-bot-server:latest']
}

task dockerPushImage(type: DockerPushImage) {
    dependsOn dockerBuildImage
    imageName = 'delegacy/young-bot-server'
    tag = 'latest'
}
